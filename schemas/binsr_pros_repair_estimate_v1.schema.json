{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://binsrpros.com/schemas/rendered-estimate.binsr_pros_repair_estimate_v1.json",
  "title": "Rendered Estimate Output (BINSR_PROS_REPAIR_ESTIMATE_V1)",
  "type": "object",
  "additionalProperties": false,
  "required": ["template_name", "job", "pricing", "line_items", "render_blocks"],
  "properties": {
    "template_name": {
      "type": "string",
      "const": "BINSR_PROS_REPAIR_ESTIMATE_V1"
    },
    "job": {
      "type": "object",
      "additionalProperties": false,
      "required": ["estimate_id", "property_address"],
      "properties": {
        "estimate_id": { "type": "string" },
        "job_id": { "type": ["string", "null"] },
        "property_address": { "type": "string" },
        "agent_name": { "type": ["string", "null"] },
        "client_name": { "type": ["string", "null"] }
      }
    },
    "pricing": {
      "type": "object",
      "additionalProperties": false,
      "required": ["tax_rate", "trip_fee", "subtotal", "tax", "total"],
      "properties": {
        "tax_rate": { "type": "number", "minimum": 0, "maximum": 1 },
        "trip_fee": {
          "type": "object",
          "additionalProperties": false,
          "required": ["mode", "amount"],
          "properties": {
            "mode": { "type": "string", "enum": ["lookup", "manual", "none"] },
            "lookup_table": { "type": ["string", "null"], "const": "tblTripFees" },
            "lookup_key": { "type": ["string", "null"] },
            "amount": { "type": "number", "minimum": 0 }
          }
        },
        "subtotal": { "type": "number", "minimum": 0 },
        "tax": { "type": "number", "minimum": 0 },
        "total": { "type": "number", "minimum": 0 }
      }
    },
    "line_items": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["canonical_item_id", "item_name", "qty", "unit", "unit_price", "total", "notes"],
        "properties": {
          "canonical_item_id": { "type": ["string", "null"] },
          "item_name": { "type": "string" },
          "qty": { "type": "number", "minimum": 0 },
          "unit": { "type": "string" },
          "unit_price": { "type": ["number", "null"], "minimum": 0 },
          "total": { "type": ["number", "null"], "minimum": 0 },
          "notes": { "type": "string" },
          "match": {
            "type": "object",
            "additionalProperties": false,
            "required": ["method"],
            "properties": {
              "method": { "type": "string", "enum": ["exact", "contains", "fuzzy", "none"] },
              "matched_alias_phrase": { "type": ["string", "null"] },
              "confidence": { "type": ["number", "null"], "minimum": 0, "maximum": 1 }
            }
          }
        }
      }
    },
    "render_blocks": {
      "type": "array",
      "minItems": 11,
      "maxItems": 11,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["template_name", "block_key", "block_type", "block_order", "value", "active"],
        "properties": {
          "template_name": { "type": "string", "const": "BINSR_PROS_REPAIR_ESTIMATE_V1" },
          "block_key": {
            "type": "string",
            "enum": [
              "HEADER_TITLE",
              "HEADER_SUBTITLE",
              "INTRO_TITLE",
              "INTRO_BODY",
              "WARRANTY_TITLE",
              "WARRANTY_BODY",
              "PAYMENT_TITLE",
              "PAYMENT_BODY",
              "TRIP_FEE_RULE",
              "TAX_RATE",
              "TOTAL_LABEL"
            ]
          },
          "block_type": { "type": "string", "enum": ["text", "number", "lookup"] },
          "block_order": { "type": "integer" },
          "value": {
            "oneOf": [
              { "type": "string" },
              { "type": "number" },
              {
                "type": "object",
                "additionalProperties": false,
                "required": ["table", "key", "result"],
                "properties": {
                  "table": { "type": "string", "const": "tblTripFees" },
                  "key": { "type": ["string", "null"] },
                  "result": { "type": "number", "minimum": 0 }
                }
              }
            ]
          },
          "active": { "type": "string", "enum": ["Y", "N"] }
        }
      },
      "allOf": [
        {
          "contains": {
            "type": "object",
            "properties": { "block_key": { "const": "TRIP_FEE_RULE" }, "block_type": { "const": "lookup" }, "block_order": { "const": 90 } },
            "required": ["block_key", "block_type", "block_order"]
          }
        },
        {
          "contains": {
            "type": "object",
            "properties": { "block_key": { "const": "TAX_RATE" }, "block_type": { "const": "number" }, "block_order": { "const": 100 } },
            "required": ["block_key", "block_type", "block_order"]
          }
        }
      ]
    }
  }
}
